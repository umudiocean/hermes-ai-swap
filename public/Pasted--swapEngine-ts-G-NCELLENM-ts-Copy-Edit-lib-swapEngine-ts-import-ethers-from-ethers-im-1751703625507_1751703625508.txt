 swapEngine.ts (GÃœNCELLENMÄ°Å)
ts
Copy
Edit
// lib/swapEngine.ts

import { ethers } from "ethers";
import { getRouterContract } from "./contracts";
import { WBNB_ADDRESS } from "./constants";

export async function performSwap({
  provider,
  signer,
  tokenOut,
  amountInBNB,
  slippagePercent = 0.5,
  userAddress
}: {
  provider: ethers.providers.Web3Provider;
  signer: ethers.Signer;
  tokenOut: string;
  amountInBNB: string;
  slippagePercent?: number;
  userAddress: string;
}) {
  try {
    const router = getRouterContract(signer);

    const amountIn = ethers.utils.parseEther(amountInBNB);

    const path = [WBNB_ADDRESS, tokenOut];

    const amountsOut = await router.getAmountsOut(amountIn, path);
    const amountOutMin = amountsOut[1].sub(
      amountsOut[1].mul(Math.floor(slippagePercent * 100)).div(10000)
    );

    const deadline = Math.floor(Date.now() / 1000) + 60 * 5; // 5 dakika

    const tx = await router.swapExactETHForTokens(
      amountOutMin,
      path,
      userAddress,
      deadline,
      {
        value: amountIn, // BNB gÃ¶nderimi burada yapÄ±lÄ±r
        gasLimit: 400000
      }
    );

    const receipt = await tx.wait();
    return receipt;
  } catch (error: any) {
    console.error("Swap failed:", error);
    throw error;
  }
}
ğŸ“Œ BaÄŸlantÄ±lÄ± Sabitler (constants.ts):
ts
Copy
Edit
export const WBNB_ADDRESS = "0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c";
export const PANCAKESWAP_V2_ROUTER = "0x10ED43C718714eb63d5aA57B78B54704E256024E"; // mainnet V2
ğŸ“Œ contracts.ts iÃ§indeki getRouterContract fonksiyonu:
ts
Copy
Edit
import { ethers } from "ethers";
import PANCAKE_ROUTER_ABI from "./abis/pancakeRouter.json";
import { PANCAKESWAP_V2_ROUTER } from "./constants";

export function getRouterContract(signer: ethers.Signer) {
  return new ethers.Contract(PANCAKESWAP_V2_ROUTER, PANCAKE_ROUTER_ABI, signer);
}
Bu gÃ¼ncellenmiÅŸ swapEngine.ts artÄ±k:

âœ… value alanÄ±na token adresi deÄŸil, BNB miktarÄ±nÄ± doÄŸru giriyor.

âœ… FixedNumber hatasÄ±nÄ± Ã§Ã¶zÃ¼yor.

âœ… Slippage ve amountOutMin deÄŸerini doÄŸru hesaplÄ±yor.

âœ… Tamamen PancakeSwapâ€™Ä±n gerÃ§ek yÃ¶nlendiricisini kullanÄ±yor.

âœ… Tek iÅŸlemle swap yapÄ±yor.